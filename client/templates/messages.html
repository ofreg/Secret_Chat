<style>
.container {
    display: flex;
    height: 80vh;
}

.sidebar {
    width: 30%;
    border-right: 1px solid #ccc;
    padding: 10px;
}

.chat-area {
    width: 70%;
    padding: 10px;
    display: flex;
    flex-direction: column;
}

.messages {
    flex: 1;
    border: 1px solid #ccc;
    overflow-y: auto;
    margin-bottom: 10px;
    padding: 5px;
}
</style>

<div class="container">

    <div class="sidebar">
        <h3>Ваші чати</h3>

        {% if chats %}
            <ul>
            {% for chat in chats %}
                <li>
                    <a href="/messages?chat_id={{ chat.id }}">
                        Чат {{ chat.id }}
                    </a>
                </li>
            {% endfor %}
            </ul>
        {% else %}
            <p>Чатів поки немає</p>
        {% endif %}

        <hr>

        <h4>Пошук користувача</h4>
        <input id="searchInput" placeholder="Введіть email">
        <div id="searchResults"></div>
    </div>

    <div class="chat-area">

        {% if request.query_params.get("chat_id") %}
            <div class="messages" id="chat"></div>

            <div>
                <input id="messageInput" placeholder="Повідомлення">
                <button onclick="sendMessage()">Надіслати</button>
            </div>
        {% else %}
            <p>Оберіть чат або знайдіть користувача</p>
        {% endif %}

    </div>

</div>

<script>
const params = new URLSearchParams(window.location.search);
const chatId = params.get("chat_id");

let socket;

if (chatId) {
    socket = new WebSocket(`ws://${window.location.host}/ws/${chatId}`);

    socket.onmessage = function(event) {
        const chat = document.getElementById("chat");
        chat.innerHTML += `<div>${event.data}</div>`;
        chat.scrollTop = chat.scrollHeight;
    };
}

function sendMessage() {
    const input = document.getElementById("messageInput");
    if (!input.value) return;

    socket.send(input.value);
    input.value = "";
}

/* ----------- SEARCH ----------- */

const searchInput = document.getElementById("searchInput");
const searchResults = document.getElementById("searchResults");

searchInput.addEventListener("input", async function() {
    const query = searchInput.value;

    if (query.length < 2) {
        searchResults.innerHTML = "";
        return;
    }

    const response = await fetch(`/messages/search?query=${query}`);
    const users = await response.json();

    searchResults.innerHTML = "";

    if (users.length === 0) {
        searchResults.innerHTML = "<p>Нічого не знайдено</p>";
        return;
    }

    users.forEach(user => {
        const div = document.createElement("div");
        div.innerHTML = `
            ${user.email}
            <button onclick="startChat('${user.email}')">Написати</button>
        `;
        searchResults.appendChild(div);
    });
});

async function startChat(email) {
    const formData = new FormData();
    formData.append("email", email);

    await fetch("/messages/start", {
        method: "POST",
        body: formData
    });

    location.reload();
}
</script>